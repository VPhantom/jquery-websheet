// Copyright 2013 St√©phane Lavergne <http://www.imars.com/> Free software under <http://www.gnu.org/licenses/lgpl-3.0.txt>
(function(t){"use strict";function e(t,e){switch(e){case"fr":return parseFloat(t.replace(",",".").replace(/[^0-9\.+\-]/g,""));default:return parseFloat(t.replace(/[^0-9\.+\-]/g,""))}}function a(e,a,s,r){var n=[],i=t(e).find("tbody");switch(i.find("tr").each(function(){n.push(t(this).detach())}),r){case"bool":case"number":case"amount":case"date":n.sort(function(e,s){return t(e).prop("__data")[a]-t(s).prop("__data")[a]});break;default:n.sort(function(e,s){var r=""+t(e).prop("__data")[a].toUpperCase(),n=""+t(s).prop("__data")[a].toUpperCase();return r>n?1:n>r?-1:0})}s&&n.reverse(),i.append(n)}t.fn.websheet=function(s){var r="en",n=0,i=!1,c="Download spreadsheet",o="Loading...",l="An error occured while attempting to load data.",d=".xls",h=null,p=/[^a-zA-Z0-9]+/g,u=/[:+\/#?]+/g,_=/([^a-zA-Z0-9]+)/;return s&&(s.lang&&(r=s.lang),s.init_sort_col&&(n=s.init_sort_col),s.init_sort_desc&&(i=s.init_sort_desc),s.dl_title&&(c=s.dl_title),s.loading&&(o=s.loading),s.callback&&(h=s.callback)),this.each(function(){var s=t(this),f=s.attr("data-filename-format").split(_)||["table"],m=s.attr("data-source"),b=m+f+d,v=t("<div>"),g=t("<span>");"/"!==m.slice(-1)&&(m+="/"),s.prop("last_submit",{}),s.append(g),s.after(v),s.submit(function(){var _=s.serializeArray(),g={},w=0,C=f.length;for(b=m,t.each(_,function(t,e){e.value&&"_"!==e.name.substr(0,1)&&(b+=e.name.replace(p,"")+":"+e.value.replace(u,"")+"/"),g[e.name]=e.value}),w=0;C>w;w++)b+=void 0!==g[f[w]]?g[f[w]].replace(u,""):f[w];return b+=d,v.html(o),t.ajax({url:b,dataType:"html",processData:!1,success:function(o){var l=t("<div>"),d=null,p=null,u=[],_=n,f=i,m=s.prop("__websheet_sort_col"),w=s.prop("__websheet_sort_desc"),C=s.prop("__websheet_sort_title");s.prop("last_submit",g),l.html(o),d=l.find("table").first().detach(),v.empty(),d.addClass("websheet"),p=d.find("caption").first().detach(),0===p.length&&(p=t("<caption>")),p.append(' <span class="websheet_download"><a href="'+b+'">'+c+"</a></span>"),d.prepend(p),d.find("thead tr").first().children().each(function(e){m===e&&C===t(this).text()&&(_=m,f=w);var r=t(this).attr("class");u.push(r),t(this).click(function(){var n=t(this).hasClass(i?"desc":"asc"),c=n!==i,o=c?"desc":"asc";d.find("thead tr").first().children().removeClass("asc desc"),a(d,e,c,r),t(this).addClass(o),s.prop("__websheet_sort_col",e).prop("__websheet_sort_desc",c).prop("__websheet_sort_title",t(this).text())})}),d.find("tbody tr").each(function(){var a=[];t(this).children().each(function(s){var n=t(this).text(),i=0;switch(t(this).addClass(u[s]),u[s]){case"bool":a.push(""!==n.trim());break;case"number":case"amount":i=e(n,r),a.push(i);break;case"date":a.push(new Date(n.trim().replace(/[\s\.\-]+/g,"/")));break;default:a.push(n.trim())}}),t(this).prop("__data",a)}),v.append(d),null!==h&&h(s,d),a(d,_,f,u[_]),d.find("thead tr").first().children().eq(_).addClass(f?"desc":"asc")},error:function(){v.html(l)}}),!1}),s.on("setState",function(e,a){var s,r=!1;return g.empty(),s=t(this).find("select, input"),s.each(function(){t(this).hasClass("__widget_field")||void 0===a[t(this).attr("name")]||a[t(this).attr("name")]===t(this).val()||(r=!0,t(this).val(a[t(this).attr("name")]),delete a[t(this).attr("name")])}),t(this).find(".__widget_form").each(function(){t(this).triggerHandler("setState",a)&&(r=!0)}),t.each(a,function(e){g.append(t("<input>").attr({type:"hidden",name:e,value:a[e]})),r=!0}),t(this).submit(),r}),s.on("getState",function(){return t(this).prop("last_submit")})})}})(jQuery);